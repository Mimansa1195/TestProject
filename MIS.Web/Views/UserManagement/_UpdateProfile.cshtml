<link href="~/Content/lib/profile-2.min.css" rel="stylesheet" />
<div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 id="modalTitle" class="modal-title">Update Profile</h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-xl-12 col-lg-12">
                <section class="tabs-section">
                    <div class="tabs-section-nav tabs-section-nav-left">
                        <ul class="nav" role="tablist">
                            <li class="nav-item" id="tabPendingTimeSheets">
                                <a class="nav-link active" href="#tabs-2-tab-1" role="tab" data-toggle="tab">
                                    <span class="nav-link-in text-green">Update Profile</span>
                                </a>
                            </li>
                            <li class="nav-item" id="tabPendingAddress">
                                <a class="nav-link " href="#tabs-2-tab-3" role="tab" data-toggle="tab">
                                    <span class="nav-link-in text-green">Update Address</span>
                                </a>
                            </li>
                            <li class="nav-item" id="tabApprovedTimeSheets">
                                <a class="nav-link" href="#tabs-2-tab-2" role="tab" data-toggle="tab">
                                    <span class="nav-link-in text-green">Change Password</span>
                                </a>
                            </li>
                        </ul>
                    </div><!--.tabs-section-nav-->

                    <div class="tab-content no-styled profile-tabs">
                        <div role="tabpanel" class="tab-pane active" id="tabs-2-tab-1">
                            <section class="box-typical box-typical-padding">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="box box-primary">
                                            <div class="box-body box-profile">
                                                <div id="divUpdateForm">
                                                    <div class="col-md-6">
                                                        <section class="box-typical profile-side-user" style="border:0px">
                                                            <div type="button" class="avatar-preview avatar-preview-128 margin-bottom-0" id="btnImageFile">
                                                                <img id="profileImage" alt="User profile picture">
                                                                <span class="update">
                                                                    <i class="font-icon font-icon-picture-double"></i>
                                                                    Update photo
                                                                </span>
                                                                <input type="file" required id="imageFile" onchange="checkFileIsValid(this);" />

                                                            </div>

                                                            <label style="color:red" id="txtImg"></label>
                                                        </section>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="control-label">Mobile number<span class="spnError">*</span></label>
                                                            <div class="inputGroupContainer">
                                                                <div class="input-group">
                                                                    <span class="input-group-addon"><i class="fa fa-mobile"></i></span>
                                                                    <input id="contactNo" placeholder="Mobile number" class="form-control validation-required" type="text" maxlength="10" onkeypress="return isNumber(event);" onkeyup="return removeAlphabets(this)" onkeydown="return removeAlphabets(this)">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="control-label">Extn. number<span class="spnError">*</span></label>
                                                            <div class="inputGroupContainer">
                                                                <div class="input-group">
                                                                    <span class="input-group-addon"><i class="fa fa-phone"></i></span>
                                                                    <input id="extnNo" placeholder="Extn. number" class="form-control validation-required" type="text" maxlength="3" onkeypress="return isNumber(event);" onkeyup="return removeAlphabets(this)" onkeydown="return removeAlphabets(this)">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6  text-right">
                                                        <div class="form-group">
                                                            <button id="btnUpdate" type="button" class="btn btn-success"><i class="fa fa-save"></i>&nbsp;Update</button>
                                                            <button id="btnUpdateProfileClose" type="button" class="btn btn-default"><i class="fa fa-times"></i>&nbsp;Close </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                </div>
                                                <!-- /.box-body -->
                                            </div>
                                        </div>

                                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                            <label style="color:red" id="txtMsg"></label>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div><!--.tab-pane-->

                        <div role="tabpanel" class="tab-pane" id="tabs-2-tab-3">
                            <section class="box-typical box-typical-padding">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="box box-primary">
                                            <div class="box-body box-profile">

                                                <div id="divUpdateFormAdd">
                                                    <div class="col-md-12">
                                                        <h6 class="text-warning"><strong> Present Address</strong></h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label">Country<span class="spnError">*</span></label>
                                                                    <div class="inputGroupContainer">
                                                                        <div class="input-group">
                                                                            <span class="input-group-addon"><i class="fa fa-list"></i></span>
                                                                            <select readonly="" class="form-control select2 validation-required" id="presentCountry" placeholder="Country" onchange="presentCountryChange();">
                                                                                <option value="0">Select</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label">State<span class="spnError">*</span></label>
                                                                    <div class="inputGroupContainer">
                                                                        <div class="input-group">
                                                                            <span class="input-group-addon"><i class="fa fa-list"></i></span>
                                                                            <select readonly="" class="form-control select2 validation-required" id="presentState" placeholder="State" onchange="presentStateChange();">
                                                                                <option value="0">Select</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label">City<span class="spnError">*</span></label>
                                                                    <div class="inputGroupContainer">
                                                                        <div class="input-group">
                                                                            <span class="input-group-addon"><i class="fa fa-list"></i></span>
                                                                            <select readonly="" class="form-control select2 validation-required" placeholder="City" id="presentCity">
                                                                                <option value="0">Select</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label">Pin code<span class="spnError">*</span></label>
                                                                    <div class="inputGroupContainer">
                                                                        <div class="input-group">
                                                                            <span class="input-group-addon"><i class="fa fa-home"></i></span>
                                                                            <input id="presentPincode" placeholder="Pincode" class="form-control validation-required" type="text" maxlength="6" onkeypress="return isNumber(event);" onkeyup="return removeAlphabets(this)" onkeydown="return removeAlphabets(this)">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <label class="control-label">Address<span class="spnError">*</span></label>
                                                                    <div class="inputGroupContainer">
                                                                        <div class="input-group">
                                                                            <span class="input-group-addon"><i class="fa fa-home"></i></span>
                                                                            <input id="presentAddress" placeholder="Present address" class="form-control validation-required" type="text">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="text-right">
                                                            <button id="btnUpdateAdd" type="button" class="btn btn-success"><i class="fa fa-save"></i>&nbsp;Update</button>
                                                            <button id="btnUpdateClose" type="button" class="btn btn-default"><i class="fa fa-times"></i>&nbsp;Close </button>
                                                        </div>

                                                    </div>
                                                </div>
                                                <!-- /.box-body -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div><!--.tab-pane-->


                        <div role="tabpanel" class="tab-pane" id="tabs-2-tab-2">
                            <section class="box-typical box-typical-padding">
                                <div class="row form-body">
                                    <div id="divChangePassword">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="control-label">Old Password<span class="spnError">*</span></label>
                                                <div class="inputGroupContainer">
                                                    <div class="input-group">
                                                        <input id="txtOldPassword" placeholder="Old Password" class="form-control validation-required" type="password">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="control-label">New Password<span class="spnError">*</span></label>
                                                <div class="inputGroupContainer">
                                                    <div class="input-group">
                                                        <input id="txtNewPassword" placeholder="New Password" class="form-control validation-required" type="password" onkeyup="CheckPasswordStrength(this.value)">
                                                        <span id="password_strength"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="control-label">Confirm Password<span class="spnError">*</span></label>
                                                <div class="inputGroupContainer">
                                                    <div class="input-group">
                                                        <input id="txtconfirmPassword" placeholder="Confirm Password" class="form-control validation-required" type="password" onchange="confirmPassword()">
                                                        <span id="password_match" style="color:red"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 text-right">
                                            <button id="btnChangePassword" type="button" class="btn btn-success"><i class="fa fa-save"></i>&nbsp;Update</button>
                                            <button id="btnChangeClose" type="button" class="btn btn-default"><i class="fa fa-times"></i>&nbsp;Close </button>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div><!--.tab-pane-->
                    </div><!--.tab-content-->
                </section><!--.tabs-section-->
            </div>
        </div>

    </div>

</div>

<script>
    var _imageData = "";
    $(document).ready(function () {
        $('#presentCountry').select2();
        $('#presentState').select2();
        $('#presentCity').select2();
        calltoAjax(misApiUrl.fetchDataForUpdateProfile, "POST", '',
            function (result) {
                if (result.IsVerified == false) {
                    $("#btnUpdate").hide();
                    $("#btnUpdateProfileClose").hide();
                    $("#txtMsg").html("Your profile update request is pending for approval.");
                }
                $("#contactNo").val(result.MobileNumber);
                $("#extnNo").val(result.Extension);
                var imagepath = result.ImageName == "" ? "../img/avatar-sign.png" : misApiProfileImageUrl + result.ImageName;

                $("#profileImage").attr("src", imagepath);
                _imageData = result.ImageName;
                bindCountryDropDown(result.CountryId);
                bindStateDropDown("#presentState", result.CountryId, result.StateId);
                bindCityDropDown("#presentCity", result.StateId, result.CityId);
                $("#presentAddress").val(result.Address);
                $("#presentPincode").val(result.PinCode);
            });
    });

    $("#btnUpdateClose").click(function () {
        $("#mypopupUpdateProfile").modal("hide");
    });

    $("#btnChangeClose").click(function () {
        $("#mypopupUpdateProfile").modal("hide");
    });

    var base64FormData;
    function checkFileIsValid(sender) {
        $("#txtImg").html("");
        var validExts = new Array(".png", ".jpeg", ".jpg", ".bmp");
        var fileExt = sender.value;
        fileExt = fileExt.substring(fileExt.lastIndexOf('.')).toLowerCase();
        var fileSize = parseInt(document.getElementById("imageFile").files[0].size / 1024);
        if (fileSize < 1024) {
            if (validExts.indexOf(fileExt) < 0) {
                misAlert("Invalid file format. Supported extensions are " + validExts.toString(), "Warning", "warning");
                $("#imageFile").val("");
                return false;
            } else {
                readURL();
                convertToBase64();
                return true;
            }
        }
        else {
            misAlert("You can not upload image more than 1 MB in size", "Warning", "warning");
            return false;
        }
    }

    function convertToBase64() {
        var selectedFile = document.getElementById("imageFile").files;
        if (selectedFile.length > 0) {
            var fileToLoad = selectedFile[0];
            var fileReader = new FileReader();
            fileReader.onload = function (fileLoadedEvent) {
                base64FormData = fileLoadedEvent.target.result;
            };
            fileReader.readAsDataURL(fileToLoad);
        }
    }

    function removeAlphabets(e) {
        $("#" + e.id).val($("#" + e.id).val().replace(/\D/g, ''));
    }


    $("#btnUpdateAdd").click(function () {
        if (!validateControls('divUpdateFormAdd')) {
            return false;
        }

        var presentPincode = $("#presentPincode").val().replace(/\D/g, '');
        $("#presentPincode").val(presentPincode)
        if (presentPincode.length != 6) {
            misAlert("Pin code should only be 6 digits.", "Warning", "warning");
            return false;
        }

        var jsonObject = {
            CountryId: $("#presentCountry").val(),
            StateId: $("#presentState").val(),
            CityId: $("#presentCity").val(),
            Address: $("#presentAddress").val(),
            PinCode: $("#presentPincode").val(),
            IsAddressPermanent: false,
            UserAbrhs: misSession.userabrhs
        }
        calltoAjax(misApiUrl.updateUserAddress, "POST", jsonObject,
            function (result) {
                if (result == 1) {
                    misAlert("Your address detail has been updated successfully.", "Success", "success");
                }
            });
    });

    $("#btnUpdateProfileClose").click(function () {
        $("#mypopupUpdateProfile").modal("hide");
    });

    $("#btnUpdate").click(function () {
        var imageName = $("#imageFile").val().replace(/^.*\\/, "");

        if (_imageData == "" && imageName == "") {
            $("#txtImg").html("Please upload your profile image");
            return false;
        }

        if (!validateControls('divUpdateForm')) {
            return false;
        }

        var contactNo = $("#contactNo").val().replace(/\D/g, '');
        $("#contactNo").val(contactNo);
        if (!contactNo.match('[0-9]{10}') && contactNo.length != 10) {
            misAlert("Please put 10 digit mobile number.", "Warning", "warning");
            return;
        }

        var extnNo = $("#extnNo").val().replace(/\D/g, '');
        $("#extnNo").val(extnNo);
        if (extnNo.length != 3) {
            misAlert("Extention number should only be 3 digits.", "Warning", "warning");
            return false;
        }
      
        var jsonObject = {
            MobileNumber: $("#contactNo").val(),
            Extension: $("#extnNo").val(),
            ImageName: imageName,
            base64FormData: base64FormData,
            AppLinkUrl: misAppUrl.changeContactDetailUrl,
            UserAbrhs: misSession.userabrhs
        }

        calltoAjax(misApiUrl.updateUserProfile, "POST", jsonObject,
            function (result) {
                if (result == 1) {
                    misAlert("Your profile update request has been sent successfully and pending for approval.", "Success", "success");
                    $("#btnUpdate").hide();
                    $("#btnUpdateProfileClose").hide();
                    $("#txtMsg").html("Your profile update request is pending for approval.");
                }
                else if (result == 2) {
                    misAlert("Your profile data is already updated.", "Warning", "warning");
                    $("#btnUpdate").show();
                }
                else
                    misAlert("Error occured", "Error", "error");
            });
    });

    function readURL() {
        if (document.getElementById("imageFile").files && document.getElementById("imageFile").files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#profileImage').attr('src', e.target.result);
            }

            reader.readAsDataURL(document.getElementById("imageFile").files[0]);
        }
    }

    function bindCountryDropDown(precSelectedId) {
        $("#presentCountry").empty();
        $("#presentCountry").append($("<option></option>").val(0).html("Select"));
        calltoAjax(misApiUrl.getCountries, "POST", '',
            function (data) {
                $.each(data, function (idx, item) {
                    $("#presentCountry").append($("<option></option>").val(item.Value).html(item.Text));
                });
                if (precSelectedId > 0) {
                    $("#presentCountry").val(precSelectedId)
                }
            });
    }

    function presentCountryChange(selectedId) {
        bindStateDropDown("#presentState", $("#presentCountry").val(), 0);
        bindCityDropDown("#presentCity", $("#presentState").val(), 0);
    }

    function bindStateDropDown(controlId, countryId, selectedvalue) {
        $(controlId).empty();
        $(controlId).append($("<option></option>").val(0).html("Select"));

        var jsonObject = {
            'countryId': countryId,
        }
        calltoAjax(misApiUrl.getStates, "POST", jsonObject,
            function (data) {
                $.each(data, function (idx, item) {
                    $(controlId).append($("<option></option>").val(item.Value).html(item.Text));
                });
                if (selectedvalue > 0)
                    $(controlId).val(selectedvalue);
            });
    }

    function bindCityDropDown(controlId, stateId, selectedvalue) {
        $(controlId).empty();
        $(controlId).append($("<option></option>").val(0).html("Select"));
        var jsonObject = {
            'stateId': stateId,
        }
        calltoAjax(misApiUrl.getCities, "POST", jsonObject,
            function (data) {
                $.each(data, function (idx, item) {
                    $(controlId).append($("<option></option>").val(item.Value).html(item.Text));
                });
                if (selectedvalue > 0)
                    $(controlId).val(selectedvalue);
            });
    }

    function presentStateChange() {
        bindCityDropDown("#presentCity", $("#presentState").val(), 0);
    }

    $("#btnChangePassword").click(function () {
        if (!validateControls('divChangePassword')) {
            return false;
        }
        if (!confirmPassword()) {
            return false;
        }
        var jsonObject = {
            oldPassword: $("#txtOldPassword").val(),
            newPassword: $("#txtNewPassword").val()
        }
        calltoAjax(misApiUrl.changePassword, "POST", jsonObject,
            function (result) {
                if (result == 1) {
                    $("#mypopupUpdateProfile").modal("hide");
                    misCountdownAlert('Your password has been changed successfully. Please sign in again', 'Success', 'success', function () {
                        misSession.signoff();
                    }, false, 5);
                }
                else if (result == 3) {
                    misAlert("The old password you entered is not valid. Please try again with correct password.", "Warning", "warning");
                }
                else if (result == 2) {
                    misAlert("Your are not a valid user.", "Warning", "warning");
                }
                else if (result == 4) {
                    misAlert("Your new password can not be same as old password.", "Warning", "warning");
                }
                else//error
                {
                    misAlert("Error occured", "Error", "error");
                }
            });
    });

    function confirmPassword() {
        var pass1 = document.getElementById("txtNewPassword").value;
        var pass2 = document.getElementById("txtconfirmPassword").value;
        if (pass1 != pass2) {
            $("#password_match").html("Password and confirm password does not match.");
            return false;
        }
        else {
            $("#password_match").html("");
        }
        return true;
    }

</script>
